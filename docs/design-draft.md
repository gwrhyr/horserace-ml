---

# 競馬予想モデル構築 詳細設計書

## 1. システム概要

本設計書は、LightGBMアルゴリズムを用いた競馬予測モデルの構築、および継続的な運用を目的としたデータ処理と学習アルゴリズムの仕様を定義するものである。

## 2. データ定義および取得設計

JV-Data4512.xlsx（JV-Data標準仕様）に基づき、学習用データセットを構築する。データはTARGET frontierJVの外部出力機能を用い、**「1頭1行（レースID × 馬番）」**の粒度で集約されたCSV形式で取得する。

### 2.1 利用レコードとマッピング

学習データは、複数のレコードを結合し、**「1頭1行（レースID × 馬番）」**の粒度で集約する。
継続的なデータ追加に対応したレコード設計である。

| カテゴリ | 対象レコード | 主要取得項目 | 役割・備考 |
| --- | --- | --- | --- |
| **レース基本** | **RA** | 年月日、競馬場、距離、馬場状態、天候、種別、条件 | レース環境の特定 |
| **出走馬情報** | **UM** | 馬番、血統登録番号、性別、齢、負担重量、**馬体重** | 個体識別および直前コンディション |
| **時系列オッズ** | **O1 / O3** | **5分前単勝オッズ、5分前複勝オッズ** | 市場評価の反映（最終オッズは使用不可） |
| **過去成績ソース** | **UM（過去）** | 確定着順、走破タイム、後3Fタイム、コーナー通過順 | 特徴量生成（通時的分析）の元データ |
| **血統情報** | **UK** | 血統登録番号、繁殖登録番号（父・母・母父） | 血統的適性の推定（マスタデータ） |

## 3. 特徴量エンジニアリング（データ加工）設計

予測精度向上および判断根拠の明確化のため、取得した生データを以下の論理に基づき加工する。加工処理はすべてPython（Pandas/Polars）上での実行を前提とする。

### 3.1 通時的分析（個体の能力・安定性評価）

過去5走の履歴から、個体の実力と成績の変動幅を算出する。集計は**Pythonでのデータ加工時**に実施する。

* **パフォーマンス指標:** 走破タイムの単純平均に加え、**「平均値 - 標準偏差」**（安定性）および**「最大値」**（最大能力）を併用し、成績のムラを考慮する。
* **適性スコア:** 今回のレース条件（競馬場、距離、馬場）と合致する過去走の成績を抽出し、偏差値化する。
* **血統別トレンド:** 最新のUKレコードに基づき、種牡馬ごとのコース別勝率を統計的に付与する。

### 3.2 共時的分析（レース内相対評価）

同一レース内の出走馬間における相対的な優位性を数値化する。

* **メンバー内偏差値:** 推定上がり3Fタイム、持ちタイム指数などを同一レース内で正規化（平均50、標準偏差10）する。
* **相対的斤量差:** 出走全馬の平均斤量に対する当該馬の増減値を算出する。
* **オッズ乖離率:** 予測される実力順位と、5分前オッズによる支持順位の差分。

## 4. 学習アルゴリズムおよび検証設計

LightGBMを用い、確率論に基づいた多クラス分類モデルを構築する。

### 4.1 タイムシリーズ・クロスバリデーション（スライディング・ウィンドウ）

3ヶ月単位で検証を行うチェックポイント方式を採用し、時間経過によるデータの陳腐化を防止する。

* **検証プロセス（時系列分割）:**
1. 基準日より3ヶ月分のデータを抽出する。
2. 当該3ヶ月間を時系列順に並べ、**「最初の約8割の期間」を学習データ**、**「残りの約2割の期間」をテストデータ**として厳密に分割する。
3. 次の3ヶ月分へウィンドウをスライドさせ、同様に「時系列順での8:2分割」による学習・検証を繰り返す。


* **継続的学習:** データが新たに追加されるたびにモデルを再構築（フル再学習）し、最新の馬場トレンドや種牡馬傾向を反映させる。

### 4.2 多クラス分類と確率出力

* **目的関数:** `multiclass` を使用し、ターゲット（正解）を「1着：1, 2着：2, 3着：3, 4着以下：0」の4値に定義する。
* **Softmax変換:** 各クラスの出力スコアに対しSoftmax関数を適用し、レース内での合計が1.0（100%）となるよう確率変換を行う。これにより、相対評価に基づいた「一着・二着・三着確率」を算出する。

## 5. 解釈性および出力設計

「ブラックボックス化」の防止策として、以下の可視化を実装する。

* **SHAP値による要因分析:** 学習に寄与した各特徴量（オッズ、馬体重、血統等）が、個別の馬の的中確率にどの程度影響を与えたかをmarimo上でグラフ化する。
* **最終出力フォーマット:**
1. 馬番
2. 馬名
3. 一着確率
4. 二着確率
5. 三着確率

## 6. 補足事項

* **集計タイミングの詳細:** 生データの取得段階では結合のみを行い、複雑な集計（過去5走の標準偏差算出など）はPython（Pandas/Polars）上で実施する。これにより、集計ロジックの修正を迅速に行うことが可能となる。
* **新馬戦の取り扱い:** 要件に基づき、学習には含めるが、過去走データが存在しないため、血統情報（UK）とオッズ（UM）を主軸とした予測となる。
---

